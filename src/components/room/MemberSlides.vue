<template>
  <ul class="member-slides py-xl">
    <li
      class="member-slides__item"
      v-for="member in members"
      :key="member.id"
      :class="{ 'member-slides__item--active': currentMemberId === member.id }"
    >
      <base-video
        :user="member.identity"
        :stream="member.stream"
        :isVideoEnabled="member.isVideoEnabled"
        :isSizeSmall="true"
      ></base-video>
      <button class="primary icon my-sm small" @click="pinMember(member)">
        <font-awesome-icon icon="arrow-up"></font-awesome-icon>
      </button>
    </li>
  </ul>
</template>

<script lang="ts">
import { useStore } from "@/store";
import { computed, defineComponent, ref, watch } from "vue";
import BaseVideo from "./BaseVideo.vue";
import { MemberData } from "@/types/roomTypes";
import { RoomMember } from "@/store/modules/room/types";

export default defineComponent({
  components: { BaseVideo },
  emits: ["member-pinned", "self-pinned"],
  setup(_, { emit }) {
    const store = useStore();
    const storeMembers = computed(() => store.state.room.members);
    const members = ref<Array<MemberData>>([]);
    const currentMemberId = ref<string>("");

    function pinMember(newMember: MemberData) {
      currentMemberId.value = newMember.id;
      emit("member-pinned", newMember);
    }

    function updateMembers(newMembers: Array<[string, RoomMember]>) {
      const oldMembers = [...members.value];
      members.value = [];
      let didCurrentMemberLeave = true;
      for (const [socketId, roomMember] of newMembers) {
        let member = oldMembers.find((m) => m.id === socketId);
        if (!member) {
          member = {
            id: socketId,
            identity: roomMember.identity,
            stream: roomMember.stream,
            isVideoEnabled: false,
          };
          roomMember.dataChannel.on("videostatechange", (data) => {
            const target = members.value.find((m) => m.id === socketId);
            if (target) target.isVideoEnabled = data.newState === "on";
          });
        }
        if (member.id === currentMemberId.value) didCurrentMemberLeave = false;
        members.value.push(member);
      }
      if (didCurrentMemberLeave) {
        currentMemberId.value = "";
        emit("self-pinned");
      }
    }

    watch(() => [...storeMembers.value], updateMembers);

    updateMembers([...storeMembers.value]);

    return { members, pinMember, currentMemberId };
  },
});
</script>

<style lang="scss" scoped>
.member-slides {
  display: grid;
  grid-auto-flow: column;
  grid-template-rows: 160px;
  grid-auto-columns: 160px;
  column-gap: 0.25rem;
  background: $dark2;

  overflow-x: scroll;
  scrollbar-width: thin;
  scrollbar-color: rgba($light1, 0.5) transparent;

  &::-webkit-scrollbar {
    background-color: transparent;
    height: 0.5rem;
  }
  &::-webkit-scrollbar-thumb {
    background-color: rgba($light3, 0.25);
    border-radius: 2rem;
    &:hover {
      background-color: rgba($light1, 0.5);
    }
  }
  &__item {
    @include overlap-children();
    grid-template-rows: 100%;
    border-radius: 0.5rem;
    overflow: hidden;
    transition: 0.2s ease-in;
    z-index: 1;
    button {
      align-self: flex-end;
      justify-self: center;
      transition: 0.2s;
      transform: translateY(120%);
      z-index: 100;
    }
    &:hover {
      box-shadow: inset 0 0 0px 0.25rem rgba($primary, 0.75);
      button {
        transform: translateY(0);
      }
    }
  }
}
</style>